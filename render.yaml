# render.yaml - Multi-service blueprint for Render
# Place at repository root (commit to the branch you selected, e.g. main)

services:
  - type: redis
    name: my-scraper-redis
    plan: free
    # Render provides a connection string via `fromService` usage below.

  - type: private_service
    name: my-scraper-flaresolverr
    dockerImage: flaresolverr/flaresolverr:latest
    plan: free
    envVars:
      - key: LOG_LEVEL
        value: "info"
    ports:
      - 8191
    # WARNING: Running FlareSolverr on Render may violate TOS or get you suspended.
    # See notes below.

  - type: web
    name: my-scraper-web
    env: docker
    dockerContext: .
    dockerfilePath: ./backend/Dockerfile
    plan: free
    autoDeploy: true
    buildCommand: ""
    startCommand: daphne -b 0.0.0.0 -p $PORT scraper_project.asgi:application
    healthCheckPath: /
    healthCheck:
      path: /
      initialDelaySeconds: 60
    envVars:
      - key: DEBUG
        value: "False"
      - key: DJANGO_ALLOWED_HOSTS
        value: $RENDER_EXTERNAL_HOSTNAME
      - key: REDIS_URL
        fromService:
          type: redis
          name: my-scraper-redis
          property: connectionString
      # Provide a full FLARESOLVERR_URL (internal host + port). Using service name + port should resolve internally.
      - key: FLARESOLVERR_URL
        value: "http://my-scraper-flaresolverr:8191"

  - type: worker
    name: my-scraper-worker
    env: docker
    dockerContext: .
    dockerfilePath: ./backend/Dockerfile
    plan: free
    startCommand: celery -A scraper_project worker --pool=threads -c 12 --loglevel=info
    envVars:
      - key: DEBUG
        value: "False"
      - key: REDIS_URL
        fromService:
          type: redis
          name: my-scraper-redis
          property: connectionString
      - key: FLARESOLVERR_URL
        value: "http://my-scraper-flaresolverr:8191"
